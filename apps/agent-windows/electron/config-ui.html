<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Monitoramento de Telas</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg: #09090b;
      --panel: #0f0f11;
      --muted: #52525b;
      --text: #f4f4f5;
      --accent: #3b82f6;
      --accent-hover: #2563eb;
      --ok: #22c55e;
      --err: #ef4444;
      --radius: 8px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: "Inter", system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 0;
      font-size: 13px;
      -webkit-font-smoothing: antialiased;
      display: flex;
      flex-direction: column;
    }

    .top {
      padding: 28px 24px 20px;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }

    .top h1 {
      font-size: 1.1rem;
      font-weight: 600;
      letter-spacing: -0.03em;
      color: var(--text);
    }

    .top p {
      margin-top: 2px;
      font-size: 12px;
      color: var(--muted);
    }

    .scroll {
      flex: 1;
      overflow-y: auto;
      padding: 20px 24px;
    }

    .block {
      margin-bottom: 20px;
    }

    .block:last-of-type { margin-bottom: 0; }

    .label {
      font-size: 11px;
      font-weight: 500;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.04em;
      margin-bottom: 6px;
    }

    input[type="url"],
    input[type="text"],
    input[type="password"],
    input[type="number"] {
      width: 100%;
      padding: 10px 12px;
      font-size: 13px;
      font-family: inherit;
      color: var(--text);
      background: var(--panel);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: var(--radius);
      outline: none;
      transition: border-color 0.15s, box-shadow 0.15s;
    }

    input::placeholder { color: var(--muted); opacity: 0.8; }

    input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.15);
    }

    .row2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .opt {
      padding-top: 16px;
      margin-top: 16px;
      border-top: 1px solid rgba(255,255,255,0.05);
    }

    .opt .label { color: var(--muted); opacity: 0.9; }

    .status {
      padding: 10px 12px;
      border-radius: var(--radius);
      font-size: 12px;
      display: none;
      margin-bottom: 12px;
    }

    .status.show { display: block; }

    .status.success { background: rgba(34, 197, 94, 0.12); color: var(--ok); }
    .status.error   { background: rgba(239, 68, 68, 0.12); color: var(--err); }
    .status.loading { background: rgba(59, 130, 246, 0.1);  color: var(--accent); }

    .actions {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 20px;
    }

    .btn {
      padding: 10px 18px;
      font-size: 13px;
      font-weight: 500;
      font-family: inherit;
      border: none;
      border-radius: var(--radius);
      cursor: pointer;
      transition: opacity 0.15s, background 0.15s;
    }

    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn:active:not(:disabled) { opacity: 0.9; }

    .btn-main {
      background: var(--accent);
      color: #fff;
    }

    .btn-main:hover:not(:disabled) { background: var(--accent-hover); }

    .btn-link {
      background: transparent;
      color: var(--muted);
      padding: 10px 0;
    }

    .btn-link:hover { color: var(--text); }

    .bottom {
      padding: 16px 24px 20px;
      border-top: 1px solid rgba(255,255,255,0.05);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 12px;
    }

    .bottom-links {
      display: flex;
      gap: 16px;
    }

    .bottom-links button {
      background: none;
      border: none;
      color: var(--muted);
      font-size: 11px;
      cursor: pointer;
      padding: 0;
    }

    .bottom-links button:hover { color: var(--text); }

    #logPathHint, #updateStatus {
      font-size: 11px;
      color: var(--muted);
      word-break: break-all;
      margin-top: 4px;
    }

    #updateStatus { display: none; }
  </style>
</head>
<body>
  <div class="top">
    <h1>Monitoramento de Telas</h1>
    <p>Conecte este PC ao servidor</p>
  </div>

  <div class="scroll">
    <form id="form">
      <div class="block">
        <label class="label" for="apiUrl">URL da API</label>
        <input type="url" id="apiUrl" name="apiUrl" placeholder="http://192.168.4.90:4001" required />
      </div>

      <div class="row2">
        <div class="block">
          <label class="label" for="agentId">ID do agente</label>
          <input type="text" id="agentId" name="agentId" placeholder="Opcional" />
        </div>
        <div class="block">
          <label class="label" for="hostname">Nome no dashboard</label>
          <input type="text" id="hostname" name="hostname" placeholder="Opcional" />
        </div>
      </div>

      <div class="block">
        <label class="label" for="registrationSecret">Segredo</label>
        <input type="password" id="registrationSecret" name="registrationSecret" placeholder="••••••••" />
      </div>

      <div class="block opt">
        <label class="label" for="screenCount">Telas</label>
        <input type="number" id="screenCount" name="screenCount" min="1" max="8" placeholder="1 = automático" />
      </div>

      <div class="status" id="status"></div>
      <div class="status" id="testResult"></div>

      <div class="actions">
        <button type="submit" class="btn btn-main" id="btnSave">Salvar e iniciar</button>
        <button type="button" class="btn btn-link" id="btnReconfig">Reconfigurar</button>
        <button type="button" class="btn btn-link" id="btnTest">Testar</button>
      </div>
    </form>
  </div>

  <div class="bottom">
    <div class="bottom-links">
      <button type="button" id="btnLog">Log</button>
      <button type="button" id="btnUpdate">Atualizações</button>
    </div>
    <div>
      <div id="logPathHint"></div>
      <div id="updateStatus"></div>
    </div>
  </div>

  <script>
    const form = document.getElementById("form");
    const statusEl = document.getElementById("status");
    const btnSave = document.getElementById("btnSave");
    const btnReconfig = document.getElementById("btnReconfig");

    function showStatus(message, type) {
      statusEl.textContent = message;
      statusEl.className = "status show " + type;
    }

    function hideStatus() {
      statusEl.className = "status";
    }

    function getFormData() {
      const sc = form.screenCount?.value?.trim();
      return {
        apiUrl: form.apiUrl.value.trim(),
        agentId: form.agentId.value.trim(),
        hostname: form.hostname.value.trim(),
        registrationSecret: form.registrationSecret.value.trim(),
        fps: 1,
        screenCount: sc ? (parseInt(sc, 10) || null) : null,
      };
    }

    function setFormData(config) {
      if (!config) return;
      form.apiUrl.value = config.apiUrl || "";
      form.agentId.value = config.agentId || "";
      form.hostname.value = config.hostname || "";
      form.registrationSecret.value = config.registrationSecret || "";
      if (form.screenCount) form.screenCount.value = config.screenCount != null ? String(config.screenCount) : "";
    }

    function setStatusFromAgent(running) {
      if (running) showStatus("Conectado. Agente em execução.", "success");
      else showStatus("Conectando… Tentando a cada 15 s se a VPN estiver fora.", "loading");
    }

    if (window.agentApi) {
      window.agentApi.onConfigLoaded((config, agentRunning) => {
        setFormData(config);
        if (config && config.apiUrl) setStatusFromAgent(agentRunning);
      });
      window.agentApi.onAgentStarted(() => {
        showStatus("Conectado. Agente em execução.", "success");
        btnSave.disabled = false;
        if (window.agentApi.minimizeToTray) window.agentApi.minimizeToTray();
      });
      window.agentApi.onAgentError((message) => {
        showStatus(message, "error");
        btnSave.disabled = false;
      });
      window.agentApi.onAgentStatus?.((running) => {
        if (running) showStatus("Conectado. Agente em execução.", "success");
        else hideStatus();
      });
      window.agentApi.loadConfig().then((result) => {
        const config = result?.config ?? result;
        const agentRunning = result && typeof result.agentRunning === "boolean" ? result.agentRunning : false;
        if (config) {
          setFormData(config);
          if (config.apiUrl) setStatusFromAgent(agentRunning);
        }
      });
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const config = getFormData();
      if (!config.apiUrl) {
        showStatus("Informe a URL da API.", "error");
        return;
      }
      hideStatus();
      btnSave.disabled = true;
      showStatus("Salvando e conectando…", "loading");
      try {
        if (window.agentApi) {
          await window.agentApi.saveConfig(config);
          await window.agentApi.startAgent(config);
        }
      } catch (err) {
        showStatus(err?.message || "Erro ao iniciar.", "error");
        btnSave.disabled = false;
      }
    });

    btnReconfig.addEventListener("click", () => {
      hideStatus();
      setFormData(getFormData());
    });

    const btnTest = document.getElementById("btnTest");
    const testResult = document.getElementById("testResult");

    function showTestResult(message, type) {
      testResult.textContent = message;
      testResult.className = "status show " + type;
    }

    const btnLog = document.getElementById("btnLog");
    const logPathHint = document.getElementById("logPathHint");
    if (btnLog && window.agentApi) {
      window.agentApi.getLogPath?.().then((p) => { if (logPathHint && p) logPathHint.textContent = p; }).catch(() => {});
      window.agentApi.openLogFolder && btnLog.addEventListener("click", () => window.agentApi.openLogFolder());
    }

    const btnUpdate = document.getElementById("btnUpdate");
    const updateStatus = document.getElementById("updateStatus");
    if (btnUpdate && window.agentApi?.checkForUpdates) {
      btnUpdate.addEventListener("click", async () => {
        updateStatus.style.display = "block";
        updateStatus.style.color = "var(--accent)";
        updateStatus.textContent = "Verificando…";
        try {
          const result = await window.agentApi.checkForUpdates();
          if (result?.hasUpdate && result?.version) {
            updateStatus.textContent = "Nova versão " + result.version + " disponível. Baixando…";
            updateStatus.style.color = "var(--ok)";
          } else {
            updateStatus.textContent = "Você está na versão mais recente.";
            updateStatus.style.color = "var(--muted)";
          }
        } catch (e) {
          updateStatus.textContent = "Não foi possível verificar.";
          updateStatus.style.color = "var(--err)";
        }
      });
      window.agentApi.onUpdateAvailable?.((v) => {
        updateStatus.textContent = "Nova versão " + v + " disponível. Baixando…";
        updateStatus.style.color = "var(--ok)";
      });
      window.agentApi.onUpdateNotAvailable?.(() => {
        updateStatus.textContent = "Você está na versão mais recente.";
        updateStatus.style.color = "var(--muted)";
      });
    } else if (btnUpdate) btnUpdate.style.display = "none";

    btnTest.addEventListener("click", async () => {
      const apiUrl = form.apiUrl.value.trim();
      const agentId = form.agentId.value.trim() || "TEST";
      if (!apiUrl) { showTestResult("Informe a URL da API.", "error"); return; }
      if (!window.agentApi?.testConnection) { showTestResult("Teste indisponível.", "error"); return; }
      showTestResult("Testando…", "loading");
      try {
        const result = await window.agentApi.testConnection(apiUrl, agentId);
        showTestResult(result?.ok ? (result.message || "Conexão OK.") : (result?.message || "Erro."), result?.ok ? "success" : "error");
      } catch (err) {
        showTestResult(err?.message || "Erro.", "error");
      }
    });
  </script>
</body>
</html>
