<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Monitoramento de Telas — Configuração</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg: #0c0c0e;
      --surface: #141416;
      --border: rgba(255,255,255,0.06);
      --text: #fafafa;
      --text-muted: #71717a;
      --accent: #3b82f6;
      --accent-hover: #2563eb;
      --success: #10b981;
      --error: #f43f5e;
      --radius: 10px;
      --radius-sm: 6px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: "Inter", -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 32px 28px 24px;
      font-size: 14px;
      -webkit-font-smoothing: antialiased;
    }

    .header {
      margin-bottom: 32px;
    }

    .header h1 {
      font-size: 1.25rem;
      font-weight: 600;
      letter-spacing: -0.02em;
      color: var(--text);
    }

    .header p {
      margin-top: 4px;
      font-size: 13px;
      color: var(--text-muted);
      font-weight: 400;
    }

    form {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .field label {
      font-size: 12px;
      font-weight: 500;
      color: var(--text-muted);
      letter-spacing: 0.01em;
    }

    .field input {
      width: 100%;
      padding: 10px 12px;
      font-size: 14px;
      font-family: inherit;
      color: var(--text);
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .field input::placeholder {
      color: var(--text-muted);
      opacity: 0.7;
    }

    .field input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
    }

    .field .hint {
      font-size: 11px;
      color: var(--text-muted);
      opacity: 0.9;
    }

    .row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .btn {
      padding: 10px 16px;
      font-size: 13px;
      font-weight: 500;
      font-family: inherit;
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: background 0.15s, opacity 0.15s;
    }

    .btn:active { opacity: 0.9; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }

    .btn-primary {
      background: var(--accent);
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      background: var(--accent-hover);
    }

    .btn-ghost {
      background: transparent;
      color: var(--text-muted);
    }

    .btn-ghost:hover {
      color: var(--text);
      background: rgba(255,255,255,0.04);
    }

    .status {
      margin-top: 4px;
      padding: 10px 12px;
      border-radius: var(--radius-sm);
      font-size: 13px;
      display: none;
    }

    .status.show { display: block; }

    .status.success {
      background: rgba(16, 185, 129, 0.12);
      color: var(--success);
    }

    .status.error {
      background: rgba(244, 63, 94, 0.12);
      color: var(--error);
    }

    .status.loading {
      background: rgba(59, 130, 246, 0.1);
      color: var(--accent);
    }

    .footer {
      margin-top: 28px;
      padding-top: 20px;
      border-top: 1px solid var(--border);
      font-size: 11px;
      color: var(--text-muted);
    }

    .footer-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 12px;
    }

    .footer-actions .btn {
      padding: 6px 12px;
      font-size: 12px;
    }

    #logPathHint, #updateStatus {
      margin-top: 8px;
      font-size: 11px;
      word-break: break-all;
    }

    #updateStatus { display: none; }
  </style>
</head>
<body>
  <header class="header">
    <h1>Monitoramento de Telas</h1>
    <p>Conecte este computador ao servidor</p>
  </header>

  <form id="form">
    <div class="field">
      <label for="apiUrl">URL da API</label>
      <input type="url" id="apiUrl" name="apiUrl" placeholder="http://192.168.4.90:4001" required />
      <span class="hint">Endereço do servidor (ex.: http://IP:4001)</span>
    </div>

    <div class="field">
      <label for="agentId">ID do agente</label>
      <input type="text" id="agentId" name="agentId" placeholder="PC-SALA-01" />
      <span class="hint">Opcional — usa o nome do PC se vazio</span>
    </div>

    <div class="field">
      <label for="hostname">Nome exibido</label>
      <input type="text" id="hostname" name="hostname" placeholder="Sala Reuniões" />
      <span class="hint">Opcional — nome no dashboard</span>
    </div>

    <div class="field">
      <label for="registrationSecret">Segredo de registro</label>
      <input type="password" id="registrationSecret" name="registrationSecret" placeholder="••••••••" />
      <span class="hint">Mesmo valor configurado na API</span>
    </div>

    <div class="field">
      <label for="screenCount">Número de telas</label>
      <input type="number" id="screenCount" name="screenCount" min="1" max="8" placeholder="1 (automático)" />
      <span class="hint">Opcional — use 2+ se tiver vários monitores</span>
    </div>

    <div class="status" id="status"></div>
    <div class="status" id="testResult"></div>

    <div class="row" style="margin-top: 4px;">
      <button type="submit" class="btn btn-primary" id="btnSave">Salvar e iniciar</button>
      <button type="button" class="btn btn-ghost" id="btnReconfig">Reconfigurar</button>
      <button type="button" class="btn btn-ghost" id="btnTest">Testar conexão</button>
    </div>
  </form>

  <footer class="footer">
    <p>Configuração salva localmente. O agente tenta conectar a cada 15 s até a API estar acessível.</p>
    <div class="footer-actions">
      <button type="button" class="btn btn-ghost" id="btnLog">Abrir pasta do log</button>
      <button type="button" class="btn btn-ghost" id="btnUpdate">Verificar atualizações</button>
    </div>
    <div id="logPathHint"></div>
    <div id="updateStatus"></div>
  </footer>

  <script>
    const form = document.getElementById("form");
    const statusEl = document.getElementById("status");
    const btnSave = document.getElementById("btnSave");
    const btnReconfig = document.getElementById("btnReconfig");

    function showStatus(message, type) {
      statusEl.textContent = message;
      statusEl.className = "status show " + type;
    }

    function hideStatus() {
      statusEl.className = "status";
    }

    function getFormData() {
      const sc = form.screenCount?.value?.trim();
      return {
        apiUrl: form.apiUrl.value.trim(),
        agentId: form.agentId.value.trim(),
        hostname: form.hostname.value.trim(),
        registrationSecret: form.registrationSecret.value.trim(),
        fps: 1,
        screenCount: sc ? (parseInt(sc, 10) || null) : null,
      };
    }

    function setFormData(config) {
      if (!config) return;
      form.apiUrl.value = config.apiUrl || "";
      form.agentId.value = config.agentId || "";
      form.hostname.value = config.hostname || "";
      form.registrationSecret.value = config.registrationSecret || "";
      if (form.screenCount) form.screenCount.value = config.screenCount != null ? String(config.screenCount) : "";
    }

    function setStatusFromAgent(running) {
      if (running) {
        showStatus("Conectado. Agente em execução.", "success");
      } else {
        showStatus("Conectando… Se a VPN estiver desconectada, o agente tentará a cada 15 s.", "loading");
      }
    }

    if (window.agentApi) {
      window.agentApi.onConfigLoaded((config, agentRunning) => {
        setFormData(config);
        if (config && config.apiUrl) setStatusFromAgent(agentRunning);
      });
      window.agentApi.onAgentStarted(() => {
        showStatus("Conectado. Agente em execução.", "success");
        btnSave.disabled = false;
        if (window.agentApi.minimizeToTray) window.agentApi.minimizeToTray();
      });
      window.agentApi.onAgentError((message) => {
        showStatus(message, "error");
        btnSave.disabled = false;
      });
      window.agentApi.onAgentStatus?.((running) => {
        if (running) showStatus("Conectado. Agente em execução.", "success");
        else hideStatus();
      });

      window.agentApi.loadConfig().then((result) => {
        const config = result && result.config ? result.config : result;
        const agentRunning = result && typeof result.agentRunning === "boolean" ? result.agentRunning : false;
        if (config) {
          setFormData(config);
          if (config.apiUrl) setStatusFromAgent(agentRunning);
        }
      });
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const config = getFormData();
      if (!config.apiUrl) {
        showStatus("Informe a URL da API.", "error");
        return;
      }
      hideStatus();
      btnSave.disabled = true;
      showStatus("Salvando e conectando…", "loading");

      try {
        if (window.agentApi) {
          await window.agentApi.saveConfig(config);
          await window.agentApi.startAgent(config);
        }
      } catch (err) {
        showStatus(err.message || "Erro ao iniciar o agente.", "error");
        btnSave.disabled = false;
      }
    });

    btnReconfig.addEventListener("click", () => {
      hideStatus();
      setFormData(getFormData());
    });

    const btnTest = document.getElementById("btnTest");
    const testResult = document.getElementById("testResult");

    function showTestResult(message, type) {
      testResult.textContent = message;
      testResult.className = "status show " + type;
    }

    const btnLog = document.getElementById("btnLog");
    const logPathHint = document.getElementById("logPathHint");
    if (btnLog && window.agentApi) {
      if (window.agentApi.getLogPath) {
        window.agentApi.getLogPath().then((p) => {
          if (logPathHint && p) logPathHint.textContent = p;
        }).catch(() => {});
      }
      if (window.agentApi.openLogFolder) {
        btnLog.addEventListener("click", () => window.agentApi.openLogFolder());
      }
    }

    const btnUpdate = document.getElementById("btnUpdate");
    const updateStatus = document.getElementById("updateStatus");
    if (btnUpdate && window.agentApi && window.agentApi.checkForUpdates) {
      btnUpdate.addEventListener("click", async () => {
        updateStatus.style.display = "block";
        updateStatus.style.color = "var(--accent)";
        updateStatus.textContent = "Verificando…";
        try {
          await window.agentApi.checkForUpdates();
          updateStatus.textContent = "Verificação concluída.";
          updateStatus.style.color = "var(--text-muted)";
        } catch (e) {
          updateStatus.textContent = "Não foi possível verificar.";
          updateStatus.style.color = "var(--error)";
        }
      });
      window.agentApi.onUpdateAvailable?.((version) => {
        updateStatus.textContent = "Nova versão " + version + " disponível, baixando…";
        updateStatus.style.color = "var(--success)";
      });
    } else if (btnUpdate) btnUpdate.style.display = "none";

    btnTest.addEventListener("click", async () => {
      const apiUrl = form.apiUrl.value.trim();
      const agentId = form.agentId.value.trim() || "TEST";
      if (!apiUrl) {
        showTestResult("Informe a URL da API.", "error");
        return;
      }
      if (!window.agentApi?.testConnection) {
        showTestResult("Teste não disponível nesta versão.", "error");
        return;
      }
      showTestResult("Testando conexão…", "loading");
      try {
        const result = await window.agentApi.testConnection(apiUrl, agentId);
        if (result?.ok) {
          showTestResult(result.message || "Conexão OK.", "success");
        } else {
          showTestResult(result?.message || "Erro ao testar.", "error");
        }
      } catch (err) {
        showTestResult(err?.message || "Erro ao testar.", "error");
      }
    });
  </script>
</body>
</html>
