<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Monitoramento de Telas</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg: #070709;
      --panel: #0e0e11;
      --muted: #6b6b76;
      --text: #f4f4f5;
      --accent: #3b82f6;
      --accent-hover: #2563eb;
      --online: #22c55e;
      --offline: #6b6b76;
      --error: #ef4444;
      --r: 8px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: "Inter", system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      font-size: 12px;
      -webkit-font-smoothing: antialiased;
    }

    .head {
      padding: 20px 24px 18px;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }

    .head-left h1 {
      font-size: 1rem;
      font-weight: 600;
      letter-spacing: -0.02em;
      color: var(--text);
    }

    .head-left p {
      margin-top: 4px;
      font-size: 11px;
      color: var(--muted);
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 500;
      flex-shrink: 0;
    }

    .status-pill .dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--offline);
    }

    .status-pill.online .dot { background: var(--online); box-shadow: 0 0 8px var(--online); }
    .status-pill.offline .dot { background: var(--offline); }
    .status-pill.error .dot { background: var(--error); box-shadow: 0 0 8px rgba(239,68,68,0.5); }
    .status-pill.connecting .dot {
      background: var(--accent);
      animation: pulse 1.2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(1.2); }
    }

    .status-pill.online { background: rgba(34, 197, 94, 0.12); color: var(--online); }
    .status-pill.offline { background: rgba(255,255,255,0.04); color: var(--muted); }
    .status-pill.error { background: rgba(239, 68, 68, 0.12); color: var(--error); }
    .status-pill.connecting { background: rgba(59, 130, 246, 0.12); color: var(--accent); }

    .form {
      padding: 20px 24px 20px;
      flex: 1;
      min-height: 0;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .field {
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .field-label {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 10px;
      font-weight: 500;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .field-label svg {
      width: 12px;
      height: 12px;
      opacity: 0.8;
    }

    input {
      width: 100%;
      padding: 9px 10px 9px 32px;
      font-size: 12px;
      font-family: inherit;
      color: var(--text);
      background: var(--panel);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: var(--r);
      outline: none;
      transition: border-color 0.15s, box-shadow 0.15s;
    }

    .field-wrap { position: relative; }
    .field-wrap .input-icon {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      width: 14px;
      height: 14px;
      pointer-events: none;
      opacity: 0.5;
    }

    input::placeholder { color: var(--muted); opacity: 0.75; }

    input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.12);
    }

    .row { display: grid; gap: 12px; }
    .row2 { grid-template-columns: 1fr 1fr; }
    .row3 { grid-template-columns: 1fr 1fr 56px; }

    .status-msg {
      padding: 9px 12px;
      border-radius: var(--r);
      font-size: 11px;
      display: none;
      flex-shrink: 0;
      align-items: center;
      gap: 8px;
    }

    .status-msg.show { display: flex; }

    .status-msg.success { background: rgba(34, 197, 94, 0.1); color: var(--online); }
    .status-msg.error   { background: rgba(239, 68, 68, 0.1);   color: var(--error); }
    .status-msg.loading { background: rgba(59, 130, 246, 0.08); color: var(--accent); }

    .status-msg svg { width: 14px; height: 14px; flex-shrink: 0; }
    .status-msg.loading svg { animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .actions {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-shrink: 0;
      margin-top: 6px;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 9px 16px;
      font-size: 12px;
      font-weight: 500;
      font-family: inherit;
      border: none;
      border-radius: var(--r);
      cursor: pointer;
      transition: opacity 0.15s, background 0.15s;
    }

    .btn svg { width: 14px; height: 14px; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn:active:not(:disabled) { opacity: 0.9; }

    .btn-main {
      background: var(--accent);
      color: #fff;
    }

    .btn-main:hover:not(:disabled) { background: var(--accent-hover); }

    .btn-ghost {
      background: rgba(255,255,255,0.04);
      color: var(--muted);
    }

    .btn-ghost:hover { color: var(--text); background: rgba(255,255,255,0.08); }

    .foot {
      padding: 14px 24px 16px;
      border-top: 1px solid rgba(255,255,255,0.04);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-shrink: 0;
    }

    .foot-links {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .foot-links button {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      background: none;
      border: none;
      color: var(--muted);
      font-size: 11px;
      cursor: pointer;
      padding: 4px 0;
    }

    .foot-links button:hover { color: var(--text); }
    .foot-links button svg { width: 13px; height: 13px; opacity: 0.9; }

    #logPathHint {
      font-size: 10px;
      color: var(--muted);
      max-width: 160px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    #updateStatus {
      font-size: 10px;
      color: var(--muted);
      max-width: 100%;
      white-space: normal;
      word-break: break-word;
      display: none;
    }
  </style>
</head>
<body>
  <header class="head">
    <div class="head-left">
      <h1>Monitoramento de Telas</h1>
      <p>Conecte este PC ao servidor</p>
    </div>
    <div class="status-pill offline" id="statusPill">
      <span class="dot"></span>
      <span id="statusPillText">Offline</span>
    </div>
  </header>

  <form id="form" class="form">
    <div class="field">
      <label class="field-label" for="apiUrl">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 12a8 8 0 0 1 8-8 8 8 0 0 1 8 8"/><line x1="2" y1="22" x2="22" y2="22"/></svg>
        URL da API
      </label>
      <div class="field-wrap">
        <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
        <input type="url" id="apiUrl" name="apiUrl" placeholder="http://192.168.4.90:4001" required style="padding-left: 32px;" />
      </div>
    </div>

    <div class="row row2">
      <div class="field">
        <label class="field-label" for="agentId">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
          ID
        </label>
        <input type="text" id="agentId" name="agentId" placeholder="Opcional" />
      </div>
      <div class="field">
        <label class="field-label" for="hostname">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
          Nome
        </label>
        <input type="text" id="hostname" name="hostname" placeholder="Opcional" />
      </div>
    </div>

    <div class="row row3">
      <div class="field" style="grid-column: span 2;">
        <label class="field-label" for="registrationSecret">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
          Segredo
        </label>
        <input type="password" id="registrationSecret" name="registrationSecret" placeholder="••••••••" />
      </div>
      <div class="field">
        <label class="field-label" for="screenCount">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/></svg>
          Telas
        </label>
        <input type="number" id="screenCount" name="screenCount" min="1" max="8" placeholder="1" title="Automático" />
      </div>
    </div>

    <div class="status-msg" id="status"></div>
    <div class="status-msg" id="testResult"></div>

    <div class="actions">
      <button type="submit" class="btn btn-main" id="btnSave">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
        Salvar e iniciar
      </button>
      <button type="button" class="btn btn-ghost" id="btnReconfig">Reconfigurar</button>
      <button type="button" class="btn btn-ghost" id="btnTest">Testar</button>
    </div>
  </form>

  <footer class="foot">
    <div class="foot-links">
      <button type="button" id="btnLog">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
        Log
      </button>
      <button type="button" id="btnUpdate">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
        Atualizações
      </button>
    </div>
    <div>
      <div id="appVersion" style="font-size: 10px; color: var(--muted); margin-bottom: 2px;"></div>
      <div id="logPathHint"></div>
      <div id="updateStatus"></div>
    </div>
  </footer>

  <script>
    const form = document.getElementById("form");
    const statusEl = document.getElementById("status");
    const statusPill = document.getElementById("statusPill");
    const statusPillText = document.getElementById("statusPillText");
    const btnSave = document.getElementById("btnSave");
    const btnReconfig = document.getElementById("btnReconfig");

    function setPill(state, text) {
      statusPill.className = "status-pill " + state;
      statusPillText.textContent = text;
    }

    function showStatus(message, type) {
      statusEl.className = "status-msg show " + type;
      var icon = "";
      if (type === "success") icon = "<svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\"><path d=\"M22 11.08V12a10 10 0 1 1-5.93-9.14\"/><polyline points=\"22 4 12 14.01 9 11.01\"/></svg>";
      else if (type === "error") icon = "<svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\"><circle cx=\"12\" cy=\"12\" r=\"10\"/><line x1=\"15\" y1=\"9\" x2=\"9\" y2=\"15\"/><line x1=\"9\" y1=\"9\" x2=\"15\" y2=\"15\"/></svg>";
      else if (type === "loading") icon = "<svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\"><line x1=\"12\" y1=\"2\" x2=\"12\" y2=\"6\"/><line x1=\"12\" y1=\"18\" x2=\"12\" y2=\"22\"/><line x1=\"4.93\" y1=\"4.93\" x2=\"7.76\" y2=\"7.76\"/><line x1=\"16.24\" y1=\"16.24\" x2=\"19.07\" y2=\"19.07\"/><line x1=\"2\" y1=\"12\" x2=\"6\" y2=\"12\"/><line x1=\"18\" y1=\"12\" x2=\"22\" y2=\"12\"/><line x1=\"4.93\" y1=\"19.07\" x2=\"7.76\" y2=\"16.24\"/><line x1=\"16.24\" y1=\"7.76\" x2=\"19.07\" y2=\"4.93\"/></svg>";
      statusEl.innerHTML = icon + " " + message;
    }

    function hideStatus() {
      statusEl.className = "status-msg";
    }

    function getFormData() {
      const sc = form.screenCount?.value?.trim();
      return {
        apiUrl: form.apiUrl.value.trim(),
        agentId: form.agentId.value.trim(),
        hostname: form.hostname.value.trim(),
        registrationSecret: form.registrationSecret.value.trim(),
        fps: 1,
        screenCount: sc ? (parseInt(sc, 10) || null) : null,
      };
    }

    function setFormData(config) {
      if (!config) return;
      form.apiUrl.value = config.apiUrl || "";
      form.agentId.value = config.agentId || "";
      form.hostname.value = config.hostname || "";
      form.registrationSecret.value = config.registrationSecret || "";
      if (form.screenCount) form.screenCount.value = config.screenCount != null ? String(config.screenCount) : "";
    }

    function setStatusFromAgent(running) {
      if (running) {
        setPill("online", "Online");
        showStatus("Conectado. Agente em execução.", "success");
      } else {
        setPill("connecting", "Conectando…");
        showStatus("Tentando a cada 15 s. Conecte a VPN para conectar automaticamente.", "loading");
      }
    }

    if (window.agentApi) {
      window.agentApi.onConfigLoaded((config, agentRunning) => {
        setFormData(config);
        if (config && config.apiUrl) setStatusFromAgent(agentRunning);
        else setPill("offline", "Offline");
      });
      window.agentApi.onAgentStarted(() => {
        setPill("online", "Online");
        showStatus("Conectado. Agente em execução.", "success");
        btnSave.disabled = false;
        if (window.agentApi.minimizeToTray) window.agentApi.minimizeToTray();
      });
      window.agentApi.onAgentError((message) => {
        setPill("error", "Erro");
        showStatus(message, "error");
        btnSave.disabled = false;
      });
      window.agentApi.onAgentStatus?.((running) => {
        if (running) {
          setPill("online", "Online");
          showStatus("Conectado. Agente em execução.", "success");
        } else {
          setPill("offline", "Offline");
          hideStatus();
        }
      });
      window.agentApi.loadConfig().then((result) => {
        const config = result?.config ?? result;
        const agentRunning = result && typeof result.agentRunning === "boolean" ? result.agentRunning : false;
        if (config) {
          setFormData(config);
          if (config.apiUrl) setStatusFromAgent(agentRunning);
          else setPill("offline", "Offline");
        } else setPill("offline", "Offline");
      });
    } else {
      setPill("offline", "Offline");
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const config = getFormData();
      if (!config.apiUrl) {
        setPill("error", "Erro");
        showStatus("Informe a URL da API.", "error");
        return;
      }
      hideStatus();
      setPill("connecting", "Conectando…");
      btnSave.disabled = true;
      showStatus("Salvando e conectando…", "loading");
      try {
        if (window.agentApi) {
          await window.agentApi.saveConfig(config);
          await window.agentApi.startAgent(config);
        }
      } catch (err) {
        setPill("error", "Erro");
        showStatus(err?.message || "Erro ao iniciar.", "error");
        btnSave.disabled = false;
      }
    });

    btnReconfig.addEventListener("click", () => {
      hideStatus();
      setPill("offline", "Offline");
      setFormData(getFormData());
    });

    const btnTest = document.getElementById("btnTest");
    const testResult = document.getElementById("testResult");

    function showTestResult(message, type) {
      testResult.className = "status-msg show " + type;
      var icon = "";
      if (type === "success") icon = "<svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\"><path d=\"M22 11.08V12a10 10 0 1 1-5.93-9.14\"/><polyline points=\"22 4 12 14.01 9 11.01\"/></svg> ";
      else if (type === "error") icon = "<svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\"><circle cx=\"12\" cy=\"12\" r=\"10\"/><line x1=\"15\" y1=\"9\" x2=\"9\" y2=\"15\"/><line x1=\"9\" y1=\"9\" x2=\"15\" y2=\"15\"/></svg> ";
      testResult.innerHTML = icon + message;
    }

    const btnLog = document.getElementById("btnLog");
    const logPathHint = document.getElementById("logPathHint");
    if (btnLog && window.agentApi) {
      window.agentApi.getLogPath?.().then((p) => { if (logPathHint && p) logPathHint.textContent = p; }).catch(() => {});
      window.agentApi.openLogFolder && btnLog.addEventListener("click", () => window.agentApi.openLogFolder());
    }

    const btnUpdate = document.getElementById("btnUpdate");
    const updateStatus = document.getElementById("updateStatus");
    const appVersionEl = document.getElementById("appVersion");
    if (window.agentApi?.getAppVersion) {
      window.agentApi.getAppVersion().then(function(v) {
        if (appVersionEl && v) appVersionEl.textContent = "Versão " + v;
      }).catch(function() {});
    }
    if (btnUpdate && window.agentApi?.checkForUpdates) {
      btnUpdate.addEventListener("click", async () => {
        updateStatus.style.display = "block";
        updateStatus.style.color = "var(--accent)";
        updateStatus.textContent = "Verificando…";
        try {
          const result = await window.agentApi.checkForUpdates();
          let gh = null;
          if (window.agentApi?.getGithubLatestRelease) {
            try { gh = await window.agentApi.getGithubLatestRelease(); } catch (_) {}
          }
          if (result?.hasUpdate && result?.version) {
            updateStatus.textContent = "v" + result.version + " disponível.";
            updateStatus.style.color = "var(--online)";
          } else {
            const v = result?.currentVersion || "";
            let msg = v ? "Você está na v" + v + " (mais recente)." : "Versão mais recente.";
            if (gh?.tag) {
              msg += " No GitHub: " + gh.tag;
              if (gh.assets?.length) msg += " — arquivos: " + gh.assets.join(", ");
              if (!result?.hasUpdate && v && gh.tag.replace(/^v/, "") !== v) {
                msg += ". Há versão nova no GitHub; se não atualizou, o asset deve se chamar monitoramento-agent.exe.";
              }
            } else if (gh?.error) {
              msg += " (GitHub: " + (gh.error === 404 ? "nenhuma release latest" : "erro " + gh.error) + ")";
            }
            updateStatus.textContent = msg;
            updateStatus.style.color = "var(--muted)";
          }
        } catch (e) {
          updateStatus.textContent = "Erro ao verificar.";
          updateStatus.style.color = "var(--error)";
        }
      });
      window.agentApi.onUpdateAvailable?.((v) => {
        updateStatus.textContent = "v" + v + " disponível.";
        updateStatus.style.color = "var(--online)";
      });
      window.agentApi.onUpdateNotAvailable?.(() => {
        window.agentApi.getAppVersion().then(function(cur) {
          updateStatus.textContent = cur ? "Você está na v" + cur + " (mais recente)." : "Versão mais recente.";
        }).catch(function() { updateStatus.textContent = "Versão mais recente."; });
        updateStatus.style.color = "var(--muted)";
      });
    } else if (btnUpdate) btnUpdate.style.display = "none";

    btnTest.addEventListener("click", async () => {
      const apiUrl = form.apiUrl.value.trim();
      const agentId = form.agentId.value.trim() || "TEST";
      if (!apiUrl) { showTestResult("Informe a URL da API.", "error"); return; }
      if (!window.agentApi?.testConnection) { showTestResult("Indisponível.", "error"); return; }
      showTestResult("Testando…", "loading");
      try {
        const result = await window.agentApi.testConnection(apiUrl, agentId);
        showTestResult(result?.ok ? "Conexão OK." : (result?.message || "Erro."), result?.ok ? "success" : "error");
      } catch (err) {
        showTestResult("Erro.", "error");
      }
    });
  </script>
</body>
</html>
