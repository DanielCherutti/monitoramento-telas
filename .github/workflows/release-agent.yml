# Build do agente Windows e publicação como Release no GitHub.
# Para publicar uma nova versão: crie uma tag (ex.: v1.0.1) e faça push.
# Ex.: git tag v1.0.1 && git push origin v1.0.1
name: Release Agente Windows

on:
  push:
    tags:
      - "v*"

jobs:
  release:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Versão a partir da tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $env:GITHUB_OUTPUT

      - name: Ajustar version no package.json do agente
        run: |
          $version = "${{ steps.version.outputs.VERSION }}"
          $path = "apps/agent-windows/package.json"
          $pkg = Get-Content $path -Raw | ConvertFrom-Json
          $pkg.version = $version
          $pkg | ConvertTo-Json -Depth 100 | Set-Content $path

      - name: Instalar dependências (raiz)
        run: npm ci

      - name: Build do agente (exe)
        run: npm run build:exe --workspace=@monitoramento/agent-windows
        env:
          CSC_IDENTITY_AUTO_DISCOVERY: "false"

      - name: Encontrar artefatos (.exe portable e instalador NSIS)
        id: artifacts
        run: |
          $dist = "apps/agent-windows/dist"
          $exes = Get-ChildItem -Path $dist -Filter "*.exe" -Recurse | Where-Object { $_.FullName -notmatch "\\win-unpacked\\" }
          if (-not $exes -or $exes.Count -eq 0) { Write-Error "Nenhum .exe encontrado em $dist" }
          $paths = $exes | ForEach-Object { $_.FullName }
          $names = $exes | ForEach-Object { $_.Name }
          echo "PATHS<<EOF" >> $env:GITHUB_OUTPUT
          echo "$($paths -join "`n")" >> $env:GITHUB_OUTPUT
          echo "EOF" >> $env:GITHUB_OUTPUT
          echo "NAMES=$($names -join ", ")" >> $env:GITHUB_OUTPUT

      - name: Criar Release e enviar artefatos
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Agente Windows ${{ steps.version.outputs.VERSION }}
          body: |
            **Portable:** baixe `monitoramento-agent.exe` e execute (sem instalação).
            **Instalador (NSIS):** use o Setup para instalar; quem instala recebe atualizações automáticas pelo app.
          files: ${{ steps.artifacts.outputs.PATHS }}
          draft: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
